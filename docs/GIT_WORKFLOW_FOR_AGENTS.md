# Git Workflow for Autonomous Agents

This document defines the git workflow that autonomous agents must follow, providing natural guardrails and review gates.

## Overview

Each agent follows this workflow:
1. **Create branch** per task (`task/{task-id}-{slug}`)
2. **Implement** changes on branch
3. **Commit** with conventional format
4. **Push** branch to remote
5. **Create PR** into main
6. **Wait for CI/reviews** (human or automated)
7. **Mark task complete** only after PR merged

## Benefits

âœ… **Review Gate** - All changes go through PR review
âœ… **Rollback** - Easy to revert bad changes
âœ… **Audit Trail** - Clear history of what agent did
âœ… **CI/CD Integration** - Tests run automatically on PR
âœ… **Human Oversight** - Team can review/approve PRs
âœ… **Safety** - No direct commits to main

## Branch Naming Convention

### Format
```
task/{task-id}-{slug}
```

### Examples
```
task/a1b2c3d4-implement-sprint-task-board
task/e5f6g7h8-add-task-ownership-api
task/i9j0k1l2-write-e2e-tests
```

### Rules
- Always prefix with `task/`
- Include full task UUID
- Add descriptive slug (lowercase, hyphen-separated)
- Max 80 characters

## Commit Message Convention

### Format
```
<type>(<scope>): <subject>

<body>

ðŸ¤– Generated with Claude Code
Task-ID: {task-id}
Story-ID: {story-id}

Co-Authored-By: Claude <noreply@anthropic.com>
```

### Types
- `feat` - New feature
- `fix` - Bug fix
- `refactor` - Code refactoring
- `test` - Adding tests
- `docs` - Documentation
- `chore` - Maintenance

### Example
```
feat(backlog): add sprint task board endpoint

Implements GET /api/v1/sprints/{sprint_id}/tasks endpoint
with filtering and grouping support.

Acceptance Criteria:
- AC1: Returns all tasks in sprint
- AC2: Supports status filtering
- AC3: Supports grouping by story/status

ðŸ¤– Generated with Claude Code
Task-ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
Story-ID: s1t2o3r4-y5i6-7890-abcd-ef1234567890

Co-Authored-By: Claude <noreply@anthropic.com>
```

## Pull Request Convention

### Title Format
```
[Task] {task-title}
```

### Example
```
[Task] Implement sprint task board endpoint
```

### Body Template
```markdown
## Task Details

**Task ID:** {task-id}
**Story:** {story-title} (#{story-id})
**Implemented by:** {agent-role} Agent

## Changes

{summary of changes}

## Acceptance Criteria

- [x] AC1: {description}
- [x] AC2: {description}
- [x] AC3: {description}

## Testing

- [x] Unit tests pass
- [x] Integration tests pass
- [x] Code quality checks pass (fmt, clippy)

## Review Checklist

- [ ] Code follows hexagonal architecture
- [ ] Tests are comprehensive
- [ ] OpenAPI specs updated (if applicable)
- [ ] No security issues
- [ ] Performance acceptable

---

ðŸ¤– Automatically generated by autonomous agent
```

## Git Workflow Steps

### Step 1: Create Branch

```bash
# Get task details
TASK_ID="a1b2c3d4-e5f6-7890-abcd-ef1234567890"
TASK_TITLE="Implement sprint task board endpoint"

# Create slug
SLUG=$(echo "$TASK_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | cut -c1-40)

# Create and checkout branch
BRANCH_NAME="task/${TASK_ID}-${SLUG}"
git checkout -b "$BRANCH_NAME"
```

### Step 2: Implement Changes

```bash
# Agent implements the task
# (via Claude Code API or CLI)
```

### Step 3: Commit Changes

```bash
# Stage all changes
git add .

# Commit with conventional format
git commit -m "$(cat <<EOF
feat(backlog): add sprint task board endpoint

Implements GET /api/v1/sprints/{sprint_id}/tasks endpoint
with filtering and grouping support.

Acceptance Criteria:
- AC1: Returns all tasks in sprint
- AC2: Supports status filtering
- AC3: Supports grouping by story/status

ðŸ¤– Generated with Claude Code
Task-ID: ${TASK_ID}
Story-ID: ${STORY_ID}

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

### Step 4: Push Branch

```bash
# Push to remote
git push origin "$BRANCH_NAME"
```

### Step 5: Create Pull Request

```bash
# Using GitHub CLI
gh pr create \
  --title "[Task] ${TASK_TITLE}" \
  --body "$(cat <<EOF
## Task Details

**Task ID:** ${TASK_ID}
**Story:** ${STORY_TITLE} (#${STORY_ID})
**Implemented by:** Dev Agent

## Changes

${CHANGE_SUMMARY}

## Acceptance Criteria

$(echo "$ACS" | jq -r '.[] | "- [x] \(.id): \(.given) â†’ \(.then_clause)"')

## Testing

- [x] Unit tests pass
- [x] Integration tests pass
- [x] Code quality checks pass (fmt, clippy)

## Review Checklist

- [ ] Code follows hexagonal architecture
- [ ] Tests are comprehensive
- [ ] OpenAPI specs updated (if applicable)
- [ ] No security issues
- [ ] Performance acceptable

---

ðŸ¤– Automatically generated by autonomous agent
EOF
)" \
  --base main
```

### Step 6: Wait for CI/Reviews

The agent should **NOT** mark the task as complete yet. Instead:

```bash
# Poll PR status
PR_NUMBER=$(gh pr view --json number -q '.number')

while true; do
  # Check CI status
  CI_STATUS=$(gh pr checks "$PR_NUMBER" --json state -q '.[0].state')

  # Check review status
  REVIEW_STATUS=$(gh pr view "$PR_NUMBER" --json reviewDecision -q '.reviewDecision')

  if [ "$CI_STATUS" = "SUCCESS" ] && [ "$REVIEW_STATUS" = "APPROVED" ]; then
    echo "PR approved and CI passed!"
    break
  fi

  if [ "$CI_STATUS" = "FAILURE" ]; then
    echo "CI failed! Agent should fix issues."
    exit 1
  fi

  echo "Waiting for CI and reviews..."
  sleep 60
done
```

### Step 7: Merge PR (Optional)

Depending on your policy, the agent can either:

**Option A: Wait for human to merge** (recommended)
```bash
# Agent waits, human merges via GitHub UI
```

**Option B: Auto-merge if approved** (risky)
```bash
# Only if CI passed and reviews approved
gh pr merge "$PR_NUMBER" --squash --delete-branch
```

### Step 8: Mark Task Complete

```bash
# Only AFTER PR is merged
curl -X POST "$API_BASE/tasks/$TASK_ID/work/complete" \
  -H "X-API-Key: $API_KEY"
```

## Integration with Claude Code Executor

Update `scripts/claude-code-executor.js`:

```javascript
async function executeTask(taskId) {
  const { task, story, acs } = await fetchTaskDetails(taskId);

  // Step 1: Create branch
  const branchName = createBranch(task);

  // Step 2: Build prompt with git instructions
  const prompt = buildPromptWithGitInstructions(task, story, acs, branchName);

  // Step 3: Execute with Claude
  await invokeClaude(prompt);

  // Step 4: Verify tests pass
  await runTests();

  // Step 5: Commit changes
  await commitChanges(task, story);

  // Step 6: Push branch
  await pushBranch(branchName);

  // Step 7: Create PR
  const prUrl = await createPullRequest(task, story, acs);

  console.log(`âœ… Pull request created: ${prUrl}`);
  console.log(`â³ Waiting for CI and reviews...`);

  // Step 8: Wait for approval
  await waitForPRApproval(prUrl);

  console.log(`âœ… PR approved and merged!`);

  return { success: true, prUrl };
}
```

## Prompt Instructions for Claude

Add to the Claude Code prompt:

```markdown
## Git Workflow

You MUST follow this git workflow:

1. âœ… You are already on branch: `{branch-name}`
2. âœ… Make your changes
3. âœ… Ensure all tests pass
4. âŒ DO NOT commit (I will commit for you)
5. âŒ DO NOT push (I will push for you)

After you finish implementing:
- All changes will be automatically committed
- A pull request will be created
- CI tests will run
- Human reviewers will check your work

Focus on writing high-quality code that will pass review!
```

## Review Gates

### Automated Gates (CI)
- âœ… All tests pass
- âœ… Code format (cargo fmt)
- âœ… Linting (cargo clippy)
- âœ… Coverage threshold (>85%)
- âœ… No security warnings

### Human Review Gates
- âœ… Code quality
- âœ… Architecture compliance
- âœ… Business logic correctness
- âœ… Security review (for sensitive changes)

### Review Policy Options

**Option 1: Always require human review** (safest)
```yaml
# .github/CODEOWNERS
* @team-leads
```

**Option 2: Auto-approve simple tasks** (faster)
```yaml
# Auto-approve if:
# - CI passes
# - Task estimated_hours <= 2
# - No security-sensitive changes
```

**Option 3: Require review by role** (balanced)
```yaml
# Dev agent PRs â†’ reviewed by QA agent
# QA agent PRs â†’ reviewed by Dev agent
# All PRs â†’ reviewed by PO agent (final approval)
```

## Agent State Management

The agent tracks task state through PR lifecycle:

```
available
  â†“
owned (branch created)
  â†“
in_progress (implementing)
  â†“
in_review (PR created)
  â†“
awaiting_merge (approved, CI passed)
  â†“
completed (PR merged)
```

Update Battra API to track PR status:

```rust
// Add to Task model
pub struct Task {
    // ... existing fields
    pub branch_name: Option<String>,
    pub pr_number: Option<i32>,
    pub pr_url: Option<String>,
    pub pr_status: Option<String>, // "open", "approved", "merged"
}
```

## Failure Handling

### CI Fails
```bash
if [ "$CI_STATUS" = "FAILURE" ]; then
  echo "CI failed. Analyzing failures..."

  # Get failure logs
  LOGS=$(gh pr checks "$PR_NUMBER" --json name,conclusion,detailsUrl)

  # Send logs back to Claude to fix
  PROMPT="CI failed with these errors:\n${LOGS}\n\nPlease fix the issues."
  invokeClaude "$PROMPT")

  # Commit fixes
  git add .
  git commit -m "fix: address CI failures"
  git push

  # Wait for CI again
fi
```

### Review Requests Changes
```bash
if [ "$REVIEW_STATUS" = "CHANGES_REQUESTED" ]; then
  echo "Changes requested by reviewer"

  # Get review comments
  COMMENTS=$(gh pr view "$PR_NUMBER" --json reviews -q '.reviews[] | .body')

  # Send to Claude
  PROMPT="Reviewer requested changes:\n${COMMENTS}\n\nPlease address the feedback."
  invokeClaude "$PROMPT")

  # Commit fixes
  git add .
  git commit -m "fix: address review feedback"
  git push
fi
```

## Rollback Procedure

If a task fails after PR merge:

```bash
# 1. Create rollback PR
git revert <commit-hash>
git push origin HEAD

# 2. Create emergency PR
gh pr create --title "[ROLLBACK] Task ${TASK_ID}" --base main

# 3. Fast-track merge
gh pr merge --admin --squash

# 4. Update task status
curl -X PATCH "$API_BASE/tasks/$TASK_ID/status" \
  -d '{"status": "failed", "reason": "Rolled back due to production issues"}'
```

## Monitoring & Metrics

Track these metrics per agent:

```typescript
interface AgentMetrics {
  tasksAttempted: number;
  prsCreated: number;
  prsApprovedFirstTime: number;  // No changes requested
  prsMerged: number;
  prsRolledBack: number;
  avgTimeToApproval: number;      // hours
  avgTimeToMerge: number;          // hours
  ciFailureRate: number;           // %
  reviewChangeRate: number;        // %
}
```

Goal: **>80% PRs approved first time**, **<5% rollback rate**

## Configuration

Add to agent config:

```bash
# Git workflow settings
export GIT_WORKFLOW_ENABLED=true
export GIT_BRANCH_PREFIX="task/"
export GIT_REQUIRE_PR=true
export GIT_AUTO_MERGE=false              # Require human approval
export GIT_PR_BASE_BRANCH="main"
export GIT_PR_DRAFT=false                # Create as ready for review
export GIT_PR_REVIEWERS="team-leads"     # Auto-assign reviewers
```

## Summary

This git workflow provides:

1. âœ… **Safety** - No direct commits to main
2. âœ… **Review** - All changes go through PR
3. âœ… **CI/CD** - Automated testing on every PR
4. âœ… **Audit** - Clear history of agent actions
5. âœ… **Rollback** - Easy to revert bad changes
6. âœ… **Compliance** - Follows team git workflow

The agent workflow becomes:
```
Get task â†’ Create branch â†’ Implement â†’ Push â†’ Create PR â†’ Wait for approval â†’ Merge â†’ Complete
```

Instead of:
```
Get task â†’ Implement â†’ Commit to main â†’ Complete âŒ
```

This is **production-ready** with proper guardrails! ðŸŽ‰
